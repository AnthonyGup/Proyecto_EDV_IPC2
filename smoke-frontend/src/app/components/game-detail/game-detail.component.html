<div class="page-wrapper">
  <app-gamer-navbar *ngIf="!inGamerLayout"></app-gamer-navbar>

  <main class="main-content">
    <div class="game-detail-container">
      <div *ngIf="loading" class="loading">
        <p>Cargando detalles del juego...</p>
      </div>

      <div *ngIf="error" class="error">
        <p>{{ error }}</p>
      </div>

      <div *ngIf="!loading && game" class="game-content">
        <!-- Header con título y precio -->
        <div class="game-header">
          <h1>{{ game.name }}</h1>
          <div class="game-meta">
            <span class="price">${{ game.price }}</span>
            <span class="age-restriction" *ngIf="game.ageRestriction > 0">+{{ game.ageRestriction }}</span>
            <span class="company" *ngIf="company">
              Empresa: <a [routerLink]="['/gamer/company', game.companyId]">{{ company.name }}</a>
            </span>
            <span class="avg-rating" *ngIf="averageRating !== null">
              <span class="stars">
                <ng-container *ngFor="let s of [1,2,3,4,5]">
                  <span class="star" [class.filled]="s <= averageStarsRounded">★</span>
                </ng-container>
              </span>
              <span class="avg-text">{{ averageRating }} / 5</span>
              <span class="count-text">({{ ratingsCount }} valoraciones)</span>
            </span>
          </div>
          <ng-container *ngIf="!isLibraryMode; else installBlock">
            <button 
              class="buy-button" 
              (click)="openBuyModal()"
              [disabled]="isLoadingBuy || !userEmail">
              {{ isLoadingBuy ? 'Comprando...' : 'Comprar Juego' }}
            </button>
          </ng-container>
          <ng-template #installBlock>
            <ng-container *ngIf="isInLibrary; else notInLibrary">
              <button 
                class="buy-button" 
                [ngClass]="isInstalled ? 'uninstall' : 'install'"
                (click)="toggleInstall()"
                [disabled]="isInstalling || !userEmail">
                {{ isInstalling ? (isInstalled ? 'Desinstalando...' : 'Instalando...') : (isInstalled ? 'Desinstalar' : 'Instalar Juego') }}
              </button>
            </ng-container>
            <ng-template #notInLibrary>
              <p class="buy-message error">Este juego no está en tu biblioteca.</p>
            </ng-template>
            <p *ngIf="installMessage" class="buy-message" [class.success]="installSuccess" [class.error]="!installSuccess">
              {{ installMessage }}
            </p>
          </ng-template>
        </div>

        <!-- Contenido principal -->
        <div class="game-main">
          <!-- Carrusel de imágenes -->
          <div class="images-section" *ngIf="gameImages.length > 0">
            <div class="image-carousel">
              <div class="carousel-main">
                <img [src]="getImageUrl(gameImages[currentImageIndex])" [alt]="game.name" />
              </div>
              <div class="carousel-controls" *ngIf="gameImages.length > 1">
                <button (click)="previousImage()" class="nav-button">❮</button>
                <button (click)="nextImage()" class="nav-button">❯</button>
              </div>
              <div class="carousel-thumbnails" *ngIf="gameImages.length > 1">
                <button
                  *ngFor="let img of gameImages; let i = index"
                  class="thumbnail"
                  [class.active]="i === currentImageIndex"
                  (click)="goToImage(i)"
                >
                  <img [src]="getImageUrl(img)" [alt]="'Imagen ' + (i + 1)" />
                </button>
              </div>
            </div>
          </div>

          <!-- Información del juego -->
          <div class="game-info">
            <div class="info-section">
              <h2>Descripción</h2>
              <p>{{ game.description }}</p>
            </div>

            <div class="info-section" *ngIf="categories.length > 0">
              <h2>Categorías</h2>
              <div class="categories-list">
                <span class="category-badge" *ngFor="let category of categories">{{ category.name }}</span>
              </div>
            </div>

            <div class="info-section">
              <h2>Información</h2>
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">Fecha de Lanzamiento:</span>
                  <span class="value">{{ game.relasedate | date: 'dd/MM/yyyy' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Requisitos Mínimos:</span>
                  <span class="value">{{ game.minimRequirements }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Calificación -->
        <div class="rating-section" *ngIf="userEmail && isBuyed">
          <h2>Tu calificación</h2>
          <div class="stars" [class.disabled]="myRating !== null">
            <button 
              *ngFor="let s of [0,1,2,3,4,5]"
              class="star"
              [class.active]="myRating !== null ? (s <= myRating) : false"
              [disabled]="ratingLoading || myRating !== null"
              (click)="setRating(s)">
              ★
            </button>
            <span class="hint" *ngIf="myRating === null">Elige 0 a 5 estrellas</span>
            <span class="hint" *ngIf="myRating !== null">Calificada: {{ myRating }} estrella(s)</span>
          </div>
          <p *ngIf="ratingMessage" class="rating-message">{{ ratingMessage }}</p>
        </div>

        <!-- Comentarios -->
        <div class="comments-section">
          <h2>Comentarios ({{ getTotalCommentCount() }})</h2>

          <div *ngIf="commentThreads.length > 0" class="comments-list">
            <ng-container *ngFor="let thread of commentThreads">
              <app-comment-thread [thread]="thread" [allowReply]="true" [nicknames]="commentNicknames" (reply)="startReply($event)"></app-comment-thread>
            </ng-container>
          </div>
          <div *ngIf="commentThreads.length === 0" class="empty">
            <p>No hay comentarios aún</p>
          </div>

          <div class="comment-form">
            <p class="replying" *ngIf="replyingTo">Respondiendo a comentario #{{ replyingTo }}</p>
            <textarea [(ngModel)]="newComment" rows="3" placeholder="Escribe un comentario"></textarea>
            <div class="form-actions">
              <button class="btn ghost" type="button" (click)="replyingTo = null" *ngIf="replyingTo">Cancelar respuesta</button>
              <button class="btn primary" type="button" (click)="submitComment()" [disabled]="commentsLoading || !userEmail">
                {{ commentsLoading ? 'Enviando...' : 'Publicar' }}
              </button>
            </div>
            <p *ngIf="commentsError" class="error">{{ commentsError }}</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <app-footer *ngIf="!inGamerLayout"></app-footer>
</div>

<!-- Modal de Compra -->
<div class="modal-overlay" *ngIf="showBuyModal" (click)="closeBuyModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmar Compra</h2>
      <button class="modal-close" (click)="closeBuyModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p><strong>{{ game?.name }}</strong></p>
      <p>Precio: <strong class="price-text">${{ game?.price }}</strong></p>
      <p *ngIf="currentWallet !== null" class="wallet-info">Tu billetera: <strong class="wallet-amount">${{ currentWallet }}</strong></p>
      <p *ngIf="currentWallet !== null && currentWallet < (game?.price || 0)" class="error-text">
        No tienes suficiente dinero en tu billetera.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeBuyModal()">Cancelar</button>
      <button 
        class="btn-confirm" 
        (click)="completeBuy()"
        [disabled]="isLoadingBuy || (currentWallet !== null && currentWallet < (game?.price || 0))">
        {{ isLoadingBuy ? 'Procesando...' : 'Confirmar Compra' }}
      </button>
    </div>
    <p *ngIf="buyMessage" class="buy-message" [class.success]="buySuccess" [class.error]="!buySuccess">
      {{ buyMessage }}
    </p>
  </div>
</div>
